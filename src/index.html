<!doctype html>
<html ng-app="TicTacToe">
  <head>
    <title>TicTacToe :: Francesco Bux</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
    <script type="text/ng-template" id="gameGridCell.html">
        <div class="game-grid-cell">
            {{content}}
        </div>
    </script>
    <script type="text/ng-template" id="gameGrid.html">
        <div class="row">
            <div class="col-xs-12">
                <div class="game-container">
                    <div class="game-grid-container">
                        <div
                            class="game-grid-row" 
                            ng-repeat="row in [] | range:size">
                            <game-grid-cell 
                                ng-repeat="col in [] | range:size" 
                                content="dots[row][col]"
                                ng-class="classes[row][col]"
                                ng-click="updateCell(row, col)"
                            />
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 text-center text-uppercase">
                <h2>Current Player : {{currentFlag}}</h2>
                <h1 ng-show="result">{{result}}</h1>

                <button class="btn btn-lg btn-primary" ng-show="result" ng-click="restart()">Restart</button>
            </div>
        </div>
    </script>
    <script type="text/javascript">
        angular
            .module('TicTacToe', [])
            .filter('range', function() {
                return function(input, total) {
                    total = parseInt(total);
                    for (var i=0; i<total; input.push(i++));
                    return input;
                };
            })
            .directive('gameGridCell', function (){
                return {
                    restrict: 'E',
                    replace: true,
                    templateUrl: 'gameGridCell.html',
                    scope: {
                        content: '=?'
                    },
                    controller: ['$scope', function($scope){
                        
                    }]
                }
            })
            .directive('gameGrid', function (){
                return {
                    restrict: 'E',
                    replace: true,
                    templateUrl: 'gameGrid.html',
                    scope: {
                        size : '=?'
                    },
                    controller: ['$scope', function($scope){
                        $scope.size = $scope.size || 3;
                        
                        var moves = 0;

                        $scope.restart = function(){
                            moves = 0;
                            $scope.dots = {};
                            $scope.classes = {};
                            $scope.currentFlag = 'O';
                            $scope.result = false;
                            $scope.endGame = false;
                        }
                        $scope.restart();


                        var toggleFlag = function(){
                            $scope.currentFlag = $scope.currentFlag == 'X' ? 'O' : 'X';
                        }

                        var highlightEndGame = function (resultObject) {
                            if('row' in resultObject){
                                if(!(resultObject.row in $scope.classes)){
                                    $scope.classes[resultObject.row] = {};
                                }
                                for(var colIndex = 0; colIndex < $scope.size; colIndex++){
                                    $scope.classes[resultObject.row][colIndex] = 'active';
                                }
                            }
                            if('col' in resultObject){
                                for(var rowIndex = 0; rowIndex < $scope.size; rowIndex++){
                                    if(!(rowIndex in $scope.classes)){
                                        $scope.classes[rowIndex] = {};
                                    }
                                    $scope.classes[rowIndex][resultObject.col] = 'active';
                                }
                            }
                            if('diag' in resultObject && resultObject.diag == 1){
                                for(var diagIndex = 0; diagIndex < $scope.size; diagIndex++){
                                    if(!(diagIndex in $scope.classes)){
                                        $scope.classes[diagIndex] = {};
                                    }
                                    $scope.classes[diagIndex][diagIndex] = 'active';
                                }
                            }
                            if('diag' in resultObject && resultObject.diag == -1){
                                for(var diagIndex = 0; diagIndex < $scope.size; diagIndex++){
                                    if(!(diagIndex in $scope.classes)){
                                        $scope.classes[diagIndex] = {};
                                    }
                                    var colIndex = ($scope.size -1 ) - diagIndex;
                                    $scope.classes[diagIndex][colIndex] = 'active';
                                }
                            }
                        }

                        var rowCheck = function(row, col, flag) {
                            for(var colIndex = 0; colIndex < $scope.size; colIndex++){
                                if($scope.dots[row][colIndex] != flag){
                                    break;
                                }
                                if(colIndex == $scope.size - 1){
                                    return {
                                        result: true,
                                        type: 'win',
                                        row: row,
                                        flag: flag
                                    }
                                }
                            }
                            return {
                                result: false
                            };
                        }

                        var colCheck = function(row, col, flag) {
                            
                            for(var rowIndex = 0; rowIndex < $scope.size; rowIndex++){
                                if(!(rowIndex in $scope.dots)){
                                    break;
                                }
                                if($scope.dots[rowIndex][col] != flag){
                                    break;
                                }
                                if(rowIndex == $scope.size - 1){
                                    return {
                                        result: true,
                                        type: 'win',
                                        col: col,
                                        flag: flag
                                    }
                                }
                            }
                            return {
                                result: false
                            };
                        }

                        var diagCheck = function(row, col, flag) {
                            
                            for(var diagIndex = 0; diagIndex < $scope.size; diagIndex++){
                                if(!(diagIndex in $scope.dots) || !(diagIndex in $scope.dots[diagIndex])){
                                    break;
                                }
                                if($scope.dots[diagIndex][diagIndex] != flag){
                                    break;
                                }
                                if([diagIndex] == $scope.size - 1){
                                    return {
                                        result: true,
                                        type: 'win',
                                        diag: 1,
                                        flag: flag
                                    }
                                }
                            }
                            return {
                                result: false
                            };
                        }

                        var counterDiagCheck = function(row, col, flag) {
                            
                            for(var diagIndex = 0; diagIndex < $scope.size; diagIndex++){
                                var colIndex = ($scope.size -1 ) - diagIndex;
                                if(!(diagIndex in $scope.dots) || !(colIndex in $scope.dots[diagIndex])){
                                    break;
                                }
                                if($scope.dots[diagIndex][colIndex] != flag){
                                    break;
                                }
                                if([diagIndex] == $scope.size - 1){
                                    return {
                                        result: true,
                                        type: 'win',
                                        diag: -1,
                                        flag: flag
                                    }
                                }
                            }
                            return {
                                result: false
                            };
                        }
                        
                        var manageEndGame = function(resultObject){
                            if(resultObject.result == false){
                                return;
                            }
                            if(resultObject.type == 'draw'){
                                $scope.result = 'Draw';
                            
                            }
                            if(resultObject.type == 'win'){
                                $scope.result = 'Player ' + resultObject.flag + ' Wins';
                                highlightEndGame(resultObject);
                            }
                            $scope.endGame = true;
                        }

                        var checkEndGame = function(row, col, flag) {
                            
                            var checkResult = rowCheck(row, col, flag);
                            if(checkResult.result){
                                manageEndGame(checkResult);
                            }
                            var checkResult = colCheck(row, col, flag);
                            if(checkResult.result){
                                manageEndGame(checkResult);
                            }
                            if(row == col){
                                var checkResult = diagCheck(row, col, flag);
                                if(checkResult.result){
                                    manageEndGame(checkResult);
                                }
                            }
                            if(row + col == $scope.size-1){
                                var checkResult = counterDiagCheck(row, col, flag); 
                                if(checkResult.result){
                                    manageEndGame(checkResult);
                                }   
                            }

                            if (moves == (Math.pow($scope.size, 2) - 1)){
                                manageEndGame({
                                    result: true,
                                    type: 'draw'
                                });
                            }
                            

                        }

                        $scope.updateCell = function(row, col){
                            if($scope.endGame){
                                return;
                            }
                            moves++;
                            if(!(row in $scope.dots)) {
                                $scope.dots[row] = {};
                            }
                            if(!(col in $scope.dots[row])) {
                                $scope.dots[row][col] = $scope.currentFlag;
                                toggleFlag();
                            }
                            checkEndGame(row, col, $scope.dots[row][col]);
                        }
                    }]
                }
            })
    </script>
  </head>
  <body>
    <div class="row-fluid">
        <div class="col-md-6 col-md-offset-3">
            <game-grid size="3" />
        </div>
    </div>
  </body>
</html>